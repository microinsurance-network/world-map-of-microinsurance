window.Mi={Models:{},Collections:{},Views:{},Routers:{},init:function(){"use strict";Mi.router=new Mi.Routers.App,Backbone.history.start()}},$(document).ready(function(){"use strict";Mi.init()}),this.JST=this.JST||{},this.JST["app/scripts/templates/countries.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)__p+='<div class="container">\n<h2>Main template</h2>\n',_.each(items,function(a){__p+="\n  "+(null==(__t=itemTemplate(a))?"":__t)+" \n"}),__p+="\n</div>";return __p},this.JST["app/scripts/templates/country.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},Mi.Routers=Mi.Routers||{},function(){"use strict";L.mapbox.accessToken="pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJnUi1mbkVvIn0.018aLhX0Mb0tdtaT2QNe2Q",Mi.map=L.mapbox.map("map","devseed.49f9443d",{worldCopyJump:!0}).setView([20,0],2),Mi.map.scrollWheelZoom.disable(),Mi.ratiosLayer=L.mapbox.featureLayer(),Mi.map.addLayer(Mi.ratiosLayer),$(document).on("click",".mi-reset",function(){Mi.year="all",Mi.region="Global",Mi.name="total-microinsurance-coverage-ratio"}),Mi.dataUrl="assets/data/mi-data.csv",Mi.data=null,Mi.models={},Mi.collections={},Mi.views={},Mi.year="all",Mi.region="Global",Mi.name="total-microinsurance-coverage-ratio",Mi.centroids=centroids,Mi.Routers.App=Backbone.Router.extend({routes:{"":"viewPage","view/:region/:year/:name":"viewPage"},execute:function(a,b){$("#content").empty().hide().fadeIn(),Mi.data?a&&a.apply(this,b):this.loadData(a,b)},loadData:function(a,b){var c=this;d3.csv(Mi.dataUrl,function(a){return{category:a.Category,mostRecent:_.reduce(a,function(a,b,c){return!isNaN(Number(c))&&Number(c)>a.year&&""!==b?{year:Number(c),value:Number(b)}:a},{year:0,value:""}),name:a.Indicator,timeseries:_.map(_.filter(_.keys(a),function(a){return!isNaN(Number(a))}),function(b){return{year:Number(b),value:Number(a[b])}}),varName:a.Indicator.split(" ").join("-").toLowerCase(),country:a.Country,region:a.Region,iso:a.iso3}},function(d,e){Mi.data=e,Mi.countries=_.unique(_.pluck(Mi.data,"country")),Mi.iso=_.unique(_.pluck(Mi.data,"iso")),Mi.indicators=_.unique(_.pluck(Mi.data,"name"));var f,g,h;_.each(Mi.indicators,function(a){f=_.pluck(_.filter(Mi.data,function(b){return b.name===a&&""!==b.mostRecent.value}),"mostRecent"),g=_.max(_.pluck(f,"value")),h=c.median(_.pluck(f,"value")),_.each(_.filter(Mi.data,function(b){return b.name===a}),function(a){a.max=g,a.median=h})}),a&&a.apply(c,b)})},viewPage:function(a,b,c){$(".loader").fadeIn(),a&&(Mi.region=this.capitalizeFirstLetter(a)),b&&(Mi.year=b),c&&(Mi.name=c),$(".menu-type a.mi-filter").each(function(){$(this).attr("data-year",Mi.year),$(this).attr("data-region",Mi.region),$(this).attr("data-type",Mi.name);var a=$(this).attr("data-var");$(this).attr("href","#view/"+Mi.region+"/"+Mi.year+"/"+a)}),$(".menu-region a.mi-filter").each(function(){$(this).attr("data-year",Mi.year),$(this).attr("data-region",Mi.region),$(this).attr("data-type",Mi.name);var a=$(this).attr("data-var");$(this).attr("href","#view/"+a+"/"+Mi.year+"/"+Mi.name)}),$(".menu-year a.mi-filter").each(function(){$(this).attr("data-year",Mi.year),$(this).attr("data-region",Mi.region),$(this).attr("data-type",Mi.name);var a=$(this).attr("data-var");$(this).attr("href","#view/"+Mi.region+"/"+a+"/"+Mi.name)});var d=[];$.each(Mi.data,function(a,b){("Global"==Mi.region||b.region===Mi.region)&&b.varName===Mi.name&&d.push(b)});var e=new Mi.Views.Countries;e.year=Mi.year,e.type=Mi.name,e.region=Mi.region,e.data=d,e.render(),$(".loader").fadeOut()},median:function(a){a.sort(function(a,b){return a-b});var b=Math.floor(a.length/2);return a.length%2?a[b]:(a[b-1]+a[b])/2},capitalizeFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}})}(),Mi.Models=Mi.Models||{},function(){"use strict";Mi.Models.Country=Backbone.Model.extend({urlRoot:"assets/data",initialize:function(){},defaults:{},validate:function(){},parse:function(a){return a}})}(),Mi.Collections=Mi.Collections||{},function(){"use strict";Mi.Collections.Countries=Backbone.Collection.extend({model:Mi.Models.Countries})}(),Mi.Views=Mi.Views||{},function(){"use strict";Mi.Views.Country=Backbone.View.extend({template:JST["app/scripts/templates/country.ejs"],tagName:"div",id:"",className:"",data:{},events:{},initialize:function(){},render:function(){console.log(this)}})}(),Mi.Views=Mi.Views||{},function(){"use strict";Mi.Views.Countries=Backbone.View.extend({template:JST["app/scripts/templates/countries.ejs"],tagName:"div",id:"",className:"",data:{},events:{},region:"",mainValue:"",year:"",type:"",initialize:function(){},render:function(){console.log(this),console.log(Mi.centroids),this.region||(this.region="Global"),$(".region-value").text(this.capitalizeFirstLetter(this.region)),$(".year-value").text("all"===this.year?"Most recent value":this.year),$(".type-value").text(this.capitalizeFirstLetter(this.type.replace(/-/g," "))),"Africa"===this.region?Mi.map.setView([4.43,28.83],3):"Americas"===this.region?Mi.map.setView([2.2,-77.26],3):"Asia"===this.region?Mi.map.setView([26.98,87.1],3):"Oceania"===this.region?Mi.map.setView([-7.36,162.6],3):Mi.map.setView([20,0],2);var a=this,b=1;Mi.ratiosLayer.clearLayers(),$.each(this.data,function(c,d){if("all"===a.year?a.mainValue=d.mostRecent.value:$.each(d.timeseries,function(b,c){parseFloat(a.year)===c.year&&(a.mainValue=c.value)}),"all"===Mi.year)var e=d.mostRecent.year;else var e=Mi.year;var f=null;$.each(Mi.centroids,function(a,b){b.iso_a3===d.iso&&(f=b.coordinates)});var g=a.mainValue;if(g>0&&4>g&&(g=3),g>29&&(g=30),null!=f&&0!=a.mainValue){var h='<div class="inner">'+d.country+", "+a.mainValue+"%</div>",i=L.circleMarker([f[1],f[0]],{radius:g,opacity:1,fillOpacity:.7,color:"#006DA1"});i.bindPopup(h,{autoPan:!0}),Mi.ratiosLayer.addLayer(i)}a.mainValue>0&&($("#content").append('<div class="col-sm-4 col-md-3 col-xs-6 row-country" data-mi-ratio="'+a.mainValue+'"><div class="inner"><b>'+d.country+"</b><br>"+d.name+'<br><span class="mi-ratio-value">'+a.mainValue+"%</span>Year: "+e+"</div></div>"),b++)}),2>b&&$("#content").append('<div class="col-md-12 no-data"><h2>No data</h2></div>'),$(".row-country").tsort({data:"mi-ratio",order:"desc"})},capitalizeFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}})}();