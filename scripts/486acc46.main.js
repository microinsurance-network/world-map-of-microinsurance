window.Mi={Models:{},Collections:{},Views:{},Routers:{},init:function(){"use strict";Mi.router=new Mi.Routers.App,Backbone.history.start()}},$(document).ready(function(){"use strict";Mi.init()}),this.JST=this.JST||{},this.JST["app/scripts/templates/countries.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)data.filter(function(a){return a.mainValue>0}).length?(__p+="\n  ",_.each(data,function(a){__p+="\n    ",a.mainValue>0&&(__p+='\n      <div class="col-sm-4 col-md-3 col-xs-6 row-country" data-mi-ratio="'+(null==(__t=a.mainValue)?"":__t)+'">\n        <div class="inner">\n          <a class="more-info" data-toggle="popover" title="'+(null==(__t=a.name)?"":__t)+'" data-content="'+(null==(__t=Mi.description[type])?"":__t)+'">?</a>\n          <b>'+(null==(__t=a.country)?"":__t)+'</b>\n          <br>\n          <span class="mi-ratio-value"><a href="#country/'+(null==(__t=a.iso)?"":__t)+'">'+(null==(__t=a.mainValue)?"":__t)+'%</a></span>\n          <span class="mi-ratio-label">'+(null==(__t=a.name)?"":__t)+'</span>\n          <div id="'+(null==(__t=a.iso)?"":__t)+'-chart" class="hchart"></div>\n          <span class="mi-crude-value">'+(null==(__t=numberWithCommas(a.crudeCoverage))?"":__t)+' policies</span>\n          <span class="mi-year-value">Year: '+(null==(__t=a.filterYear)?"":__t)+"</span>\n        </div>\n      </div>\n    "),__p+="\n  "}),__p+="\n"):__p+='\n  <h2 class="country-title">No data</h2>\n',__p+="\n";return __p},this.JST["app/scripts/templates/country.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)__p+='<h2 class="country-title">'+(null==(__t=data[0].country)?"":__t)+"</h2>\n",_.each(data,function(a,b){__p+="\n  ",a.name.indexOf("ratio")>=0&&null!=a.mostRecent.value&&a.mostRecent.value>0&&"Life coverage ratio (excluding credit life)"!=a.name&&"Life and accident coverage ratio (excluding credit life)"!=a.name&&(__p+='\n	  <div class="col-sm-4 col-md-3 col-xs-6 row-country '+(null==(__t=a.varName)?"":__t)+'">\n		  <div class="inner">\n			  <a class="more-info" href="#" data-toggle="popover" title="'+(null==(__t=a.name)?"":__t)+'" data-content="'+(null==(__t=Mi.description[a.varName])?"":__t)+'">?</a>\n				  <span class="mi-ratio-value"><a href="#country/'+(null==(__t=a.iso)?"":__t)+'">'+(null==(__t=a.indicatorValue)?"":__t)+'</a></span>\n					<span class="mi-ratio-label">'+(null==(__t=a.name)?"":__t)+'</span>\n					<div id="'+(null==(__t=a.iso)?"":__t)+"-chart-"+(null==(__t=b)?"":__t)+'" class="hchart"></div>\n					<span class="mi-crude-value">'+(null==(__t=numberWithCommas(a.crudeCoverage))?"":__t)+' policies</span>\n					<span class="mi-year-value">Year: '+(null==(__t=a.mostRecent.year)?"":__t)+"</span>\n				</div>\n			</div>\n  "),__p+="\n"}),__p+="\n";return __p},Mi.Routers=Mi.Routers||{},function(){"use strict";L.mapbox.accessToken="pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJnUi1mbkVvIn0.018aLhX0Mb0tdtaT2QNe2Q",Mi.map=L.mapbox.map("map","devseed.49f9443d",{worldCopyJump:!0}).setView([20,0],2),Mi.map.scrollWheelZoom.disable(),Mi.ratiosLayer=L.mapbox.featureLayer(),Mi.map.addLayer(Mi.ratiosLayer),$(document).on("click",".mi-reset",function(a){Mi.year="all",Mi.region="Global",Mi.name="total-microinsurance-coverage-ratio"}),Mi.dataUrl="assets/data/mi-data.csv",Mi.data=null,Mi.models={},Mi.collections={},Mi.views={},Mi.year="all",Mi.region="Global",Mi.name="total-microinsurance-coverage-ratio",Mi.centroids=centroids,Mi.description={"total-microinsurance-coverage-ratio":"Coverage of all included microinsurance products provided.","credit-life-coverage-ratio":"Coverage that repays the outstanding balance on loans in default due to the death of the borrower. Occasionally, partial or complete disability coverage is also included.","accident-coverage-ratio":"Insurance providing financial protection against an event that is unforeseen, unexpected, and unintended.","property-coverage-ratio":"Insurance providing financial protection against the loss of, or damage to, real and personal property caused by such perils as fire, theft, windstorm, hail, explosion, riot, aircraft, motor vehicles, vandalism, malicious mischief, riot and civil commotion, and smoke.","agriculture-coverage-ratio":"Insurance providing financial protection against loss due to drought, livestock disease and death, flood, and other perils impacting agriculture production.","health-coverage-ratio":"Coverage that provides benefits as a result of sickness or injury. Policies include insurance for losses from accident, medical expense, disability, or accidental death and dismemberment."},Mi.Routers.App=Backbone.Router.extend({routes:{"":"viewPage","view/:region/:year/:name":"viewPage","country/:country":"viewCountry"},execute:function(a,b){$("#content").empty().hide().fadeIn(),Mi.data?a&&a.apply(this,b):this.loadData(a,b)},loadData:function(a,b){var c=this;d3.csv(Mi.dataUrl,function(a){return{category:a.Category,mostRecent:_.reduce(a,function(a,b,c){return!isNaN(Number(c))&&Number(c)>a.year&&""!==b?{year:Number(c),value:Number(b)}:a},{year:0,value:""}),name:a.Indicator,timeseries:_.map(_.filter(_.keys(a),function(a){return!isNaN(Number(a))}),function(b){return{year:Number(b),value:Number(a[b])}}),varName:a.Indicator.split(" ").join("-").toLowerCase(),country:a.Country,region:a.Region,iso:a.iso3}},function(d,e){Mi.data=e,Mi.countries=_.unique(_.pluck(Mi.data,"country")),Mi.iso=_.unique(_.pluck(Mi.data,"iso")),Mi.indicators=_.unique(_.pluck(Mi.data,"name"));var f,g,h;_.each(Mi.indicators,function(a){f=_.pluck(_.filter(Mi.data,function(b){return b.name===a&&""!==b.mostRecent.value}),"mostRecent"),g=_.max(_.pluck(f,"value")),h=c.median(_.pluck(f,"value")),_.each(_.filter(Mi.data,function(b){return b.name===a}),function(a){a.max=g,a.median=h})}),a&&a.apply(c,b)})},viewPage:function(a,b,c){$(".loader").fadeIn(),a&&(Mi.region=this.capitalizeFirstLetter(a)),b&&(Mi.year=b),c&&(Mi.name=c),$(".menu-type a.mi-filter").each(function(){$(this).attr("data-year",Mi.year),$(this).attr("data-region",Mi.region),$(this).attr("data-type",Mi.name);var a=$(this).attr("data-var");$(this).attr("href","#view/"+Mi.region+"/"+Mi.year+"/"+a)}),$(".menu-region a.mi-filter").each(function(){$(this).attr("data-year",Mi.year),$(this).attr("data-region",Mi.region),$(this).attr("data-type",Mi.name);var a=$(this).attr("data-var");$(this).attr("href","#view/"+a+"/"+Mi.year+"/"+Mi.name)}),$(".menu-year a.mi-filter").each(function(){$(this).attr("data-year",Mi.year),$(this).attr("data-region",Mi.region),$(this).attr("data-type",Mi.name);var a=$(this).attr("data-var");$(this).attr("href","#view/"+Mi.region+"/"+a+"/"+Mi.name)});var d=[];$.each(Mi.data,function(a,b){("Global"==Mi.region||b.region===Mi.region)&&b.varName===Mi.name&&d.push(b)});var e=new Mi.Views.Countries;e.year=Mi.year,e.type=Mi.name,e.region=Mi.region,e.data=d,e.render(),$(".loader").fadeOut()},viewCountry:function(a){var b=0;Mi.ratiosLayer.eachLayer(function(a){b++}),b||(this.viewPage(),$("#content").empty()),$(".loader").fadeIn();var c=[];$.each(Mi.data,function(b,d){a===d.iso&&"Microinsurance"===d.category&&c.push(d)});var d=new Mi.Views.Country;d.year=Mi.year,d.type=Mi.name,d.region=Mi.region,d.data=c,d.iso=c[0].iso,d.render(),$(".loader").fadeOut()},median:function(a){a.sort(function(a,b){return a-b});var b=Math.floor(a.length/2);return a.length%2?a[b]:(a[b-1]+a[b])/2},capitalizeFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}})}(),Mi.Models=Mi.Models||{},function(){"use strict";Mi.Models.Country=Backbone.Model.extend({urlRoot:"assets/data",initialize:function(){},defaults:{},validate:function(a,b){},parse:function(a,b){return a}})}(),Mi.Collections=Mi.Collections||{},function(){"use strict";Mi.Collections.Countries=Backbone.Collection.extend({model:Mi.Models.Countries})}(),Mi.Views=Mi.Views||{},function(){"use strict";Mi.Views.Country=Backbone.View.extend({template:JST["app/scripts/templates/country.ejs"],tagName:"div",el:"#content",data:{},events:{},region:"",mainValue:"",metaData:"",year:"",iso:"",type:"",initialize:function(){},render:function(){var a=this,b=null;_.each(Mi.centroids,function(c){c.iso_a3===a.iso&&(b=c.coordinates,Mi.map.setView([b[1],b[0]],4),Mi.map.closePopup())}),_.each(this.data,function(b){b.indicatorValue="",b.name.indexOf("ratio")>=0?null!=b.indicatorValue&&(b.indicatorValue=b.mostRecent.value+"%",b.crudeCoverage=_.filter(a.data,function(a){return a.varName===b.varName.replace("-ratio","")})[0].mostRecent.value):b.indicatorValue=b.mostRecent.value}),this.$el.html(this.template({data:this.data,numberWithCommas:this.numberWithCommas,type:this.type})),_.each(this.data,function(b,c){if(b.name.indexOf("ratio")>=0&&null!=b.mostRecent.value&&b.mostRecent.value>0&&"Life coverage ratio (excluding credit life)"!=b.name&&"Life and accident coverage ratio (excluding credit life)"!=b.name){var d=[],e=[];$.each(b.timeseries,function(a,b){0!=b.value&&(d.push(b.value),e.push(b.year))}),a.drawLineChart("#"+b.iso+"-chart-"+c,d,e,b.name)}}),$("#map").animate({height:"250px"}),$(".more-info").popover({placement:"top",trigger:"hover",viewport:".row-country"}),$("#twitter-share-btn").attr("href","https://twitter.com/home?status="+window.location.href),$("#facebook-share-btn").attr("href","https://www.facebook.com/sharer/sharer.php?u="+window.location.href),$("#linkedin-share-btn").attr("href","https://www.linkedin.com/shareArticle?mini=true&url="+window.location.href)},drawLineChart:function(a,b,c,d){$(a).highcharts({chart:{plotBorderColor:"transparent",backgroundColor:"transparent"},title:{text:"",x:-20},subtitle:{text:"",x:-20},xAxis:{categories:c},yAxis:{title:{text:""},labels:{enabled:!1},gridLineColor:"#fff"},credits:{enabled:!1},tooltip:{valueSuffix:"%"},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0,enabled:!1},series:[{name:"Ratio",color:"#09AE8A",data:b}]})},numberWithCommas:function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},capitalizeFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}})}(),Mi.Views=Mi.Views||{},function(){"use strict";Mi.Views.Countries=Backbone.View.extend({template:JST["app/scripts/templates/countries.ejs"],el:"#content",data:{},events:{},region:"",mainValue:"",metaData:"",year:"",type:"",initialize:function(){},render:function(){this.region||(this.region="Global"),$(".region-value").text(this.capitalizeFirstLetter(this.region)),$(".year-value").text("all"===this.year?"Most recent value":this.year),$(".type-value").text(this.capitalizeFirstLetter(this.type.replace(/-/g," "))),"Africa"===this.region?Mi.map.setView([4.43,28.83],3):"Americas"===this.region?Mi.map.setView([2.2,-77.26],3):"Asia"===this.region?Mi.map.setView([26.98,87.1],3):"Oceania"===this.region?Mi.map.setView([-7.36,162.6],3):Mi.map.setView([20,0],2);var a=this;$("#twitter-share-btn").attr("href","https://twitter.com/home?status="+window.location.href),$("#facebook-share-btn").attr("href","https://www.facebook.com/sharer/sharer.php?u="+window.location.href),$("#linkedin-share-btn").attr("href","https://www.linkedin.com/shareArticle?mini=true&url="+window.location.href),Mi.ratiosLayer.clearLayers(),this.metaData=_.groupBy(Mi.data,"country"),_.each(this.data,function(b){b.crudeCoverage=0,b.crudeCoverageType="all"===a.type?"total-microinsurance-coverage":a.type.slice(0,-6),_.each(a.metaData[b.country],function(c){c.varName===b.crudeCoverageType&&("all"===a.year?b.crudeCoverage=c.mostRecent.value:_.each(c.timeseries,function(c){c.year===parseFloat(a.year)&&(b.crudeCoverage=c.value)})),"all"===a.year?b.mainValue=b.mostRecent.value:_.each(b.timeseries,function(c){parseFloat(a.year)===c.year&&(b.mainValue=c.value)}),"all"===Mi.year?b.filterYear=b.mostRecent.year:b.filterYear=Mi.year})}),this.data.sort(function(a,b){return b.mainValue-a.mainValue}),this.$el.html(this.template({data:this.data,numberWithCommas:this.numberWithCommas,type:this.type})),_.each(this.data,function(b){var c=null;_.each(Mi.centroids,function(a){a.iso_a3===b.iso&&(c=a.coordinates)});var d=b.mainValue;if(d>0&&4>d&&(d=3),d>29&&(d=30),null!=c&&0!==b.mainValue){var e='<div class="inner"><span class="country-name">'+b.country+'</span><br><span class="popup-value">'+a.capitalizeFirstLetter(a.type.replace(/-/g," "))+": "+b.mainValue+'%</span><br><a href="#country/'+b.iso+'">View profile</a></div>',f=L.circleMarker([c[1],c[0]],{radius:d,opacity:1,fillOpacity:.7,color:"#006DA1"});f.bindPopup(e,{autoPan:!0}),Mi.ratiosLayer.addLayer(f)}if(b.mainValue>0){var g=[],h=[];_.each(b.timeseries,function(a){0!=a.value&&(g.push(a.value),h.push(a.year))}),a.drawLineChart("#"+b.iso+"-chart",g,h,b.name)}}),$("#map").animate({height:"400px"}),$(".more-info").popover({placement:"top",trigger:"hover",viewport:".row-country"})},drawLineChart:function(a,b,c,d){$(a).highcharts({chart:{plotBorderColor:"#fff"},title:{text:"",x:-20},subtitle:{text:"",x:-20},xAxis:{categories:c},yAxis:{title:{text:""},labels:{enabled:!1},gridLineColor:"#fff"},credits:{enabled:!1},tooltip:{valueSuffix:"%"},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0,enabled:!1},series:[{name:"Ratio",color:"#09AE8A",data:b}]})},numberWithCommas:function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},capitalizeFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}})}();